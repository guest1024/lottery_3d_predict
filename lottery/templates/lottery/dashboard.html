{% extends 'lottery/base.html' %}

{% block title %}ä»ªè¡¨æ¿ - 3Då½©ç¥¨é¢„æµ‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px; color: #303133;">ğŸ“Š é¢„æµ‹ä»ªè¡¨æ¿</h1>

<!-- Tabå¯¼èˆª -->
<div class="tabs">
    <div class="tab-buttons">
        <button class="tab-btn" data-tab="overview">æ¦‚è§ˆ</button>
        <button class="tab-btn" data-tab="prediction">æœ€æ–°é¢„æµ‹</button>
        <button class="tab-btn" data-tab="backtest">å›æµ‹ç»“æœ</button>
        <button class="tab-btn" data-tab="strategy">æŠ•æ³¨ç­–ç•¥</button>
        <button class="tab-btn" data-tab="data">æ•°æ®ç®¡ç†</button>
    </div>
</div>

<!-- Tab 1: æ¦‚è§ˆ -->
<div class="tab-content" data-content="overview">
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label">æ€»æœŸæ•°</div>
            <div class="stat-value">{{ total_periods }}</div>
        </div>
        <div class="stat-card success">
            <div class="stat-label">æœ€æ–°æœŸå·</div>
            <div class="stat-value">{{ latest_period.period|default:"æš‚æ— " }}</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-label">é¢„æµ‹è®°å½•</div>
            <div class="stat-value">{{ latest_prediction.id|default:"0" }}</div>
        </div>
        <div class="stat-card danger">
            <div class="stat-label">æ•°æ®æ›´æ–°</div>
            <div class="stat-value" style="font-size: 16px;">
                {% if latest_update %}
                    {{ latest_update.created_at|date:"Y-m-d H:i" }}
                {% else %}
                    æœªæ›´æ–°
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if latest_period %}
    <div class="card">
        <div class="card-title">æœ€æ–°å¼€å¥–</div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <p style="color: #909399; margin-bottom: 10px;">æœŸå·: {{ latest_period.period }}</p>
                <div class="lottery-balls">
                    <div class="ball">{{ latest_period.digit1 }}</div>
                    <div class="ball">{{ latest_period.digit2 }}</div>
                    <div class="ball">{{ latest_period.digit3 }}</div>
                </div>
            </div>
            <div>
                <p><span class="tag tag-info">å½¢æ€: {{ latest_period.shape }}</span></p>
                <p style="margin-top: 8px;"><span class="tag tag-info">å’Œå€¼: {{ latest_period.sum_value }}</span></p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-title">æœ€ä½³ç­–ç•¥æ¨è</div>
        {% if best_strategy %}
        <table class="table">
            <tr>
                <th>ç­–ç•¥åç§°</th>
                <th>ROI</th>
                <th>èƒœç‡</th>
                <th>æœ€å¤§å›æ’¤</th>
                <th>æ“ä½œ</th>
            </tr>
            <tr>
                <td><strong>{{ best_strategy.strategy_name }}</strong></td>
                <td>
                    <span class="{% if best_strategy.roi_percentage >= 0 %}tag-success{% else %}tag-danger{% endif %} tag">
                        {{ best_strategy.roi_percentage|floatformat:2 }}%
                    </span>
                </td>
                <td>{{ best_strategy.win_rate|floatformat:2 }}%</td>
                <td>{{ best_strategy.max_drawdown|floatformat:2 }}%</td>
                <td><a href="{% url 'lottery:backtest_detail' best_strategy.pk %}" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">æŸ¥çœ‹è¯¦æƒ…</a></td>
            </tr>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <p>æš‚æ— å›æµ‹æ•°æ®</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tab 2: æœ€æ–°é¢„æµ‹ -->
<div class="tab-content" data-content="prediction">
    <div class="card">
        <div class="card-title">ç”Ÿæˆæ–°é¢„æµ‹</div>
        <p style="color: #606266; margin-bottom: 15px;">åŸºäºæœ€è¿‘30æœŸå†å²æ•°æ®ç”Ÿæˆä¸‹ä¸€æœŸé¢„æµ‹</p>
        <button onclick="generatePrediction()" class="btn btn-primary">ğŸ¯ ç”Ÿæˆé¢„æµ‹</button>
    </div>
    
    {% if latest_prediction %}
    <div class="card">
        <div class="card-title">æœ€æ–°é¢„æµ‹ç»“æœ</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <p style="color: #909399; margin-bottom: 10px;">é¢„æµ‹æœŸå·: <strong>{{ latest_prediction.predicted_for_period }}</strong></p>
                <p style="color: #909399; margin-bottom: 10px;">å¯ä¿¡åº¦: 
                    <span class="{% if latest_prediction.confidence_score >= 0.19 %}tag-success{% elif latest_prediction.confidence_score >= 0.188 %}tag-warning{% else %}tag-info{% endif %} tag">
                        {{ latest_prediction.confidence_score|floatformat:4 }}
                    </span>
                </p>
                <p style="color: #909399; margin-bottom: 10px;">Top5æ•°å­—: 
                    {% for digit in latest_prediction.top5_digits %}
                        <span class="ball" style="width: 32px; height: 32px; font-size: 14px; margin-right: 5px;">{{ digit }}</span>
                    {% endfor %}
                </p>
            </div>
            <div>
                <p style="color: #909399; margin-bottom: 10px;">æŠ•æ³¨å»ºè®®: 
                    {% if latest_prediction.should_bet %}
                        <span class="tag tag-success">âœ“ å»ºè®®æŠ•æ³¨</span>
                    {% else %}
                        <span class="tag tag-warning">âœ— æš‚ä¸å»ºè®®</span>
                    {% endif %}
                </p>
                <p style="color: #909399; margin-bottom: 10px;">å»ºè®®é‡‘é¢: <strong>Â¥{{ latest_prediction.bet_amount }}</strong></p>
                <p style="color: #909399; font-size: 13px;">é¢„æµ‹æ—¶é—´: {{ latest_prediction.created_at|date:"Y-m-d H:i:s" }}</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <p>æš‚æ— é¢„æµ‹è®°å½•ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆé¢„æµ‹</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tab 3: å›æµ‹ç»“æœ -->
<div class="tab-content" data-content="backtest">
    <div class="card">
        <div class="card-title">å†å²å›æµ‹å¯¹æ¯”</div>
        {% if backtest_results %}
        <table class="table">
            <thead>
                <tr>
                    <th>ç­–ç•¥åç§°</th>
                    <th>æµ‹è¯•æœŸæ•°</th>
                    <th>æŠ•æ³¨æœŸæ•°</th>
                    <th>èµ·å§‹èµ„é‡‘</th>
                    <th>æœ€ç»ˆèµ„é‡‘</th>
                    <th>ROI</th>
                    <th>èƒœç‡</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for backtest in backtest_results %}
                <tr>
                    <td><strong>{{ backtest.strategy_name }}</strong></td>
                    <td>{{ backtest.total_periods }}</td>
                    <td>{{ backtest.bet_periods }}</td>
                    <td>Â¥{{ backtest.starting_capital|floatformat:0 }}</td>
                    <td>Â¥{{ backtest.final_capital|floatformat:0 }}</td>
                    <td>
                        <span class="{% if backtest.roi_percentage >= 0 %}tag-success{% else %}tag-danger{% endif %} tag">
                            {{ backtest.roi_percentage|floatformat:2 }}%
                        </span>
                    </td>
                    <td>{{ backtest.win_rate|floatformat:2 }}%</td>
                    <td>{{ backtest.max_drawdown|floatformat:2 }}%</td>
                    <td><a href="{% url 'lottery:backtest_detail' backtest.pk %}" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">è¯¦æƒ…</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“ˆ</div>
            <p>æš‚æ— å›æµ‹æ•°æ®</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tab 4: æŠ•æ³¨ç­–ç•¥ -->
<div class="tab-content" data-content="strategy">
    <div class="card">
        <div class="card-title">åŠ¨æ€æŠ•æ³¨ç­–ç•¥è¯´æ˜</div>
        <div style="color: #606266; line-height: 1.8;">
            <h3 style="margin: 15px 0; color: #303133;">âœ… Top 10% ç­–ç•¥ï¼ˆæ¨èï¼‰</h3>
            <ul style="margin-left: 20px;">
                <li>åªåœ¨å¯ä¿¡åº¦Top 10%çš„æœŸæ•°æŠ•æ³¨</li>
                <li>å†å²ROI: -3.35%ï¼ˆè¿œä¼˜äºå…¨æŠ•æ³¨-43.83%ï¼‰</li>
                <li>èƒœç‡: 15%ï¼ˆvs å…¨æŠ•æ³¨8.5%ï¼‰</li>
                <li>æœ€å¤§å›æ’¤: 6.21%</li>
                <li>æŠ•æ³¨é¢‘ç‡: çº¦10%æœŸæ•°ï¼ˆ200æœŸæŠ•20æœŸï¼‰</li>
            </ul>
            
            <h3 style="margin: 15px 0; color: #303133;">ğŸ¯ æŠ•æ³¨æµç¨‹</h3>
            <ol style="margin-left: 20px;">
                <li>ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æ¯æœŸå¯ä¿¡åº¦åˆ†æ•°</li>
                <li>åªåœ¨å¯ä¿¡åº¦â‰¥é˜ˆå€¼æ—¶ç»™å‡ºæŠ•æ³¨å»ºè®®</li>
                <li>æ¨èç»„åˆï¼ˆç»„ä¸‰+ç»„å…­ï¼‰ï¼Œçº¦20-30æ³¨</li>
                <li>å»ºè®®é‡‘é¢æ ¹æ®å¯ä¿¡åº¦åŠ¨æ€è°ƒæ•´</li>
            </ol>
            
            <h3 style="margin: 15px 0; color: #303133;">âš ï¸ é£é™©æç¤º</h3>
            <ul style="margin-left: 20px; color: #f56c6c;">
                <li>å½©ç¥¨å±äºè´ŸæœŸæœ›å€¼æ¸¸æˆï¼Œå³ä½¿æœ€ä¼˜ç­–ç•¥ä»ä¼šäºæŸ</li>
                <li>å†å²è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š</li>
                <li>ä»…ä¾›å¨±ä¹å‚è€ƒï¼Œè¯·ç†æ€§æŠ•æ³¨</li>
                <li>ä¸è¦ç”¨ç”Ÿæ´»å¿…éœ€èµ„é‡‘å‚ä¸</li>
            </ul>
        </div>
    </div>
</div>

<!-- Tab 5: æ•°æ®ç®¡ç† -->
<div class="tab-content" data-content="data">
    <div class="card">
        <div class="card-title">æ•°æ®æ›´æ–°</div>
        <p style="color: #606266; margin-bottom: 15px;">çˆ¬å–æœ€æ–°å¼€å¥–æ•°æ®å¹¶è‡ªåŠ¨å»é‡å¯¼å…¥æ•°æ®åº“</p>
        <button onclick="crawlLatestData()" class="btn btn-success">ğŸ•·ï¸ çˆ¬å–æœ€æ–°æ•°æ®</button>
        <div id="crawl-status" style="margin-top: 15px;"></div>
    </div>
    
    <div class="card">
        <div class="card-title">æ•°æ®ç»Ÿè®¡</div>
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-label">æ•°æ®åº“æ€»æœŸæ•°</div>
                <div class="stat-value">{{ total_periods }}</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">æœ€æ–°æœŸå·</div>
                <div class="stat-value">{{ latest_period.period|default:"N/A" }}</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">æœ€æ–°æ—¥æœŸ</div>
                <div class="stat-value" style="font-size: 18px;">{{ latest_period.date|date:"Y-m-d"|default:"N/A" }}</div>
            </div>
        </div>
    </div>
    
    {% if update_logs %}
    <div class="card">
        <div class="card-title">æ›´æ–°æ—¥å¿—</div>
        <table class="table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>æ–°å¢</th>
                    <th>æ›´æ–°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ¶ˆæ¯</th>
                </tr>
            </thead>
            <tbody>
                {% for log in update_logs %}
                <tr>
                    <td>{{ log.created_at|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ log.update_type }}</td>
                    <td>{{ log.periods_added }}</td>
                    <td>{{ log.periods_updated }}</td>
                    <td>
                        <span class="{% if log.status == 'success' %}tag-success{% else %}tag-danger{% endif %} tag">
                            {{ log.status }}
                        </span>
                    </td>
                    <td>{{ log.message|truncatewords:10 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// çˆ¬å–æœ€æ–°æ•°æ®
async function crawlLatestData() {
    const btn = event.target;
    const statusDiv = document.getElementById('crawl-status');
    
    btn.disabled = true;
    btn.textContent = 'çˆ¬å–ä¸­...';
    statusDiv.innerHTML = '<p style="color: #409eff;">ğŸ•·ï¸ æ­£åœ¨çˆ¬å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>';
    
    try {
        const response = await fetch("{% url 'lottery:api_crawl' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            statusDiv.innerHTML = `
                <div style="color: #67c23a; padding: 12px; background: #f0f9ff; border-radius: 4px;">
                    <p><strong>âœ“ ${data.message}</strong></p>
                    <p style="margin-top: 8px; font-size: 14px;">
                        æ–°å¢: ${data.added}æœŸ | æ›´æ–°: ${data.updated}æœŸ | æ€»è®¡: ${data.total}æœŸ
                    </p>
                </div>
            `;
            
            // 3ç§’ååˆ·æ–°é¡µé¢
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            statusDiv.innerHTML = `<p style="color: #f56c6c;">âœ— ${data.message}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p style="color: #f56c6c;">âœ— è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ•·ï¸ çˆ¬å–æœ€æ–°æ•°æ®';
    }
}

// ç”Ÿæˆé¢„æµ‹
async function generatePrediction() {
    const btn = event.target;
    
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
        const response = await fetch("{% url 'lottery:api_predict' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showMessage(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showMessage(data.message, 'error');
        }
    } catch (error) {
        showMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ¯ ç”Ÿæˆé¢„æµ‹';
    }
}
</script>
{% endblock %}
