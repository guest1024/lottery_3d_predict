{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时任务调度器 - 3D彩票预测系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .status-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        .job-card {
            margin-bottom: 1rem;
            border-left: 4px solid #0d6efd;
        }
        .execution-success {
            background-color: #d1e7dd;
        }
        .execution-error {
            background-color: #f8d7da;
        }
        .btn-run {
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'lottery:index' %}">
                <i class="bi bi-graph-up"></i> 3D彩票预测系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lottery:index' %}">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lottery:dashboard' %}">仪表板</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'lottery:investment_strategy' %}">投资策略</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'lottery:scheduler_status' %}">定时任务</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="bi bi-clock-history"></i> 定时任务调度器
        </h1>

        <!-- 调度器状态 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> 调度器状态</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>运行状态:</h6>
                        {% if scheduler_status.running %}
                            <span class="badge bg-success status-badge">
                                <i class="bi bi-check-circle"></i> 运行中
                            </span>
                        {% else %}
                            <span class="badge bg-danger status-badge">
                                <i class="bi bi-x-circle"></i> 已停止
                            </span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>已注册任务数:</h6>
                        <span class="badge bg-info status-badge">
                            {{ scheduler_status.jobs|length }} 个任务
                        </span>
                    </div>
                </div>
                
                {% if not scheduler_status.running %}
                <div class="alert alert-warning mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> 
                    调度器未运行。请使用以下命令启动：
                    <pre class="mt-2 mb-0"><code>python manage.py start_scheduler</code></pre>
                    或
                    <pre class="mt-2 mb-0"><code>./start_scheduler.sh --daemon</code></pre>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 已注册任务列表 -->
        {% if scheduler_status.running and scheduler_status.jobs %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-list-task"></i> 已注册的定时任务</h5>
            </div>
            <div class="card-body">
                {% for job in scheduler_status.jobs %}
                <div class="card job-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title mb-2">
                                    <i class="bi bi-calendar-check"></i> {{ job.name }}
                                </h5>
                                <p class="card-text mb-1">
                                    <strong>任务ID:</strong> <code>{{ job.id }}</code>
                                </p>
                                <p class="card-text mb-1">
                                    <strong>触发器:</strong> {{ job.trigger }}
                                </p>
                                <p class="card-text mb-0">
                                    <strong>下次运行:</strong> 
                                    {% if job.next_run_time %}
                                        <span class="badge bg-info">{{ job.next_run_time }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">无</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary btn-run" onclick="runTaskNow('{{ job.id }}')">
                                    <i class="bi bi-play-fill"></i> 立即运行
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- 最近执行记录 -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> 最近执行记录</h5>
            </div>
            <div class="card-body">
                {% if recent_executions %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>状态</th>
                                <th>运行时间</th>
                                <th>耗时</th>
                                <th>异常信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exec in recent_executions %}
                            <tr class="{% if exec.status == 'Executed' %}execution-success{% elif exec.status == 'Error' %}execution-error{% endif %}">
                                <td><code>{{ exec.job.id }}</code></td>
                                <td>
                                    {% if exec.status == 'Executed' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> 成功
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i> {{ exec.status }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ exec.run_time|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    {% if exec.duration %}
                                        {{ exec.duration|floatformat:2 }}秒
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if exec.exception %}
                                        <small class="text-danger">{{ exec.exception|truncatewords:10 }}</small>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">暂无执行记录</p>
                {% endif %}
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="card mt-4 mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> 使用说明</h5>
            </div>
            <div class="card-body">
                <h6>启动调度器</h6>
                <pre><code># 前台运行
python manage.py start_scheduler

# 后台运行
./start_scheduler.sh --daemon

# 测试模式（立即运行一次评估）
./start_scheduler.sh --test</code></pre>

                <h6 class="mt-3">停止调度器</h6>
                <pre><code>./start_scheduler.sh --stop</code></pre>

                <h6 class="mt-3">查看状态</h6>
                <pre><code>./start_scheduler.sh --status</code></pre>

                <h6 class="mt-3">定时任务说明</h6>
                <ul>
                    <li><strong>每日机会评估:</strong> 每天 9:00 自动评估投资机会</li>
                    <li><strong>每周数据爬取:</strong> 每周一 8:00 自动爬取最新开奖数据</li>
                    <li><strong>清理过期记录:</strong> 每天 2:00 清理7天前的任务执行记录</li>
                </ul>

                <div class="alert alert-info mt-3" role="alert">
                    <i class="bi bi-info-circle"></i> 
                    点击 "立即运行" 按钮可以手动触发任务，无需等待预定时间。
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 立即运行任务的JavaScript -->
    <script>
        function runTaskNow(taskId) {
            if (!confirm(`确定要立即运行任务 "${taskId}" 吗？`)) {
                return;
            }

            // 显示加载状态
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 执行中...';

            // 发送API请求
            fetch('{% url "lottery:api_run_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('✓ ' + data.message);
                    // 刷新页面以显示新的执行记录
                    location.reload();
                } else {
                    alert('✗ ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            })
            .catch(error => {
                alert('请求失败: ' + error);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            });
        }
    </script>
</body>
</html>
