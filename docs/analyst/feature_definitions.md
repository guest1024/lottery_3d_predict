# 特征定义说明文档

本文档详细说明Lotto3D-Core系统中使用的特征工程方法，包括数学定义、计算逻辑和物理意义。

## 1. 基础形态特征

### 1.1 AC值（算术复杂性 Arithmetic Complexity）

**数学定义：**

设一组三个号码为 $(n_0, n_1, n_2)$，其中 $n_i \in [0, 9]$。

计算所有两两差值的绝对值：
$$
D = \{|n_i - n_j| : 0 \le i < j < 3\}
$$

AC值定义为集合 $D$ 中不同元素的个数：
$$
AC = |D|
$$

**取值范围：** 1 ≤ AC ≤ 3

**物理意义：**
- **AC=1**: 所有差值相同（如111豹子，或123等差数列），表示高度规则性
- **AC=2**: 部分差值相同（如对子或部分三不同），表示中等复杂性
- **AC=3**: 所有差值不同，表示完全随机/高度离散

**计算示例：**

1. 号码 [1, 2, 3]
   - 差值：|1-2|=1, |1-3|=2, |2-3|=1
   - 去重：{1, 2}
   - AC值 = 2

2. 号码 [1, 1, 1]
   - 差值：|1-1|=0, |1-1|=0, |1-1|=0
   - 去重：{0}
   - AC值 = 1

3. 号码 [0, 3, 7]
   - 差值：|0-3|=3, |0-7|=7, |3-7|=4
   - 去重：{3, 4, 7}
   - AC值 = 3

**应用策略：**
- AC值用于衡量号码的"随机程度"
- 在过滤阶段，可以根据模型预测的AC值分布筛选候选组合
- 历史统计显示，AC=2和AC=3的出现频率较高

---

### 1.2 和值（Sum Value）

**数学定义：**

$$
S = n_0 + n_1 + n_2
$$

**取值范围：** 0 ≤ S ≤ 27

**扩展特征：**
1. **归一化和值**: $S_{norm} = \frac{S}{27}$
2. **和尾（012路）**: $S \bmod 3$
3. **和尾（个位数）**: $S \bmod 10$

**统计特性：**
- 和值服从近似正态分布，均值约为13.5
- 极端和值（0-5, 22-27）出现概率较低
- 常见和值范围：10-17

---

### 1.3 跨度（Span）

**数学定义：**

$$
Span = \max(n_0, n_1, n_2) - \min(n_0, n_1, n_2)
$$

**取值范围：** 0 ≤ Span ≤ 9

**分类：**
- **小跨度**: Span ≤ 3
- **中跨度**: 4 ≤ Span ≤ 6
- **大跨度**: Span ≥ 7

**物理意义：**
跨度衡量号码的"分散程度"，与AC值有一定相关性但不完全等价。

---

## 2. 统计趋势特征

### 2.1 遗漏值（Omission Value）

**定义：**

对于位置 $p \in \{0, 1, 2\}$（百位、十位、个位）和数字 $d \in [0, 9]$，遗漏值 $O_{p,d}(t)$ 定义为：

$$
O_{p,d}(t) = t - \max\{t' < t : n_p(t') = d\} - 1
$$

即数字 $d$ 在位置 $p$ 上自上次出现后已经缺失的期数。

**特殊情况：**
- 如果数字从未出现过，遗漏值 = 当前期数

**应用：**
- 遗漏值用于捕捉"冷热号"规律
- 高遗漏值的数字被认为"该出"（回归理论）
- 低遗漏值的数字被认为"热号"

---

### 2.2 滚动统计特征

**均值（Rolling Mean）：**

对于窗口大小 $w$，在时刻 $t$ 计算过去 $w$ 期的和值均值：

$$
\mu_S^{(w)}(t) = \frac{1}{w} \sum_{i=t-w}^{t-1} S(i)
$$

**标准差（Rolling Std）：**

$$
\sigma_S^{(w)}(t) = \sqrt{\frac{1}{w} \sum_{i=t-w}^{t-1} (S(i) - \mu_S^{(w)}(t))^2}
$$

**偏度（Skewness）：**

$$
Skew_S^{(w)}(t) = \frac{\frac{1}{w} \sum_{i=t-w}^{t-1} (S(i) - \mu_S^{(w)}(t))^3}{\sigma_S^{(w)}(t)^3}
$$

**窗口大小选择：**
- 短期（5期）：捕捉最近趋势
- 中期（10期）：平滑短期波动
- 长期（30期）：反映长期规律

---

### 2.3 滚动相关系数

**位置间相关：**

计算位置 $i$ 和位置 $j$ 在窗口 $w$ 内的皮尔逊相关系数：

$$
\rho_{ij}^{(w)}(t) = \frac{\sum_{k=t-w}^{t-1} (n_i(k) - \bar{n}_i)(n_j(k) - \bar{n}_j)}{\sqrt{\sum_{k=t-w}^{t-1} (n_i(k) - \bar{n}_i)^2} \sqrt{\sum_{k=t-w}^{t-1} (n_j(k) - \bar{n}_j)^2}}
$$

**应用：**
- $\rho_{01}$: 百位与十位的联动性
- $\rho_{02}$: 百位与个位的联动性
- $\rho_{12}$: 十位与个位的联动性

相关系数接近1表示正相关，接近-1表示负相关，接近0表示独立。

---

## 3. 玄学逻辑特征（可选）

### 3.1 五行生克

**映射规则：**
- 0, 5 → 土（Earth）
- 1, 6 → 水（Water）
- 2, 7 → 火（Fire）
- 3, 8 → 木（Wood）
- 4, 9 → 金（Metal）

**相生关系：**
木→火→土→金→水→木

**相克关系：**
木克土、土克水、水克火、火克金、金克木

**特征提取：**
统计本期号码内部及与上期号码的生克关系数量。

---

### 3.2 位置互换（Pattern Shift）

**定义：**

检测上期某位置的数字是否出现在本期的不同位置。

例如：
- 上期：[1, 2, 3]
- 本期：[3, 1, 2]
- 检测到：百位1移至十位、十位2移至个位、个位3移至百位

---

## 4. 特征归一化与预处理

### 4.1 归一化方法

1. **Min-Max归一化：**
   $$
   x_{norm} = \frac{x - x_{min}}{x_{max} - x_{min}}
   $$

2. **Z-score标准化：**
   $$
   x_{std} = \frac{x - \mu}{\sigma}
   $$

### 4.2 缺失值处理

- 对于新特征，如果历史数据不足，填充0或均值
- 对于遗漏值，如果数字从未出现，设置为最大历史期数

---

## 5. 特征重要性评估

可以通过以下方法评估特征重要性：

1. **随机森林特征重要性**
2. **SHAP值分析**
3. **消融实验**（Ablation Study）

建议定期评估并剔除冗余或无效特征，以提升模型效率。

---

## 6. 代码实现参考

所有特征的实现位于 `src/features/` 目录：
- `morphology.py`: 形态特征
- `statistical.py`: 统计特征
- `metaphysical.py`: 玄学特征

每个特征类继承自 `BaseFeature`，并通过 `@register_feature` 装饰器自动注册。

---

## 附录：参考文献

1. 《彩票号码统计分析方法》
2. 《时间序列特征工程》
3. Pearson Correlation Coefficient - Wikipedia
4. Arithmetic Complexity in Number Theory

---

**更新日期：** 2024-01-01  
**版本：** v1.0  
**维护者：** Lotto3D-Core Team
