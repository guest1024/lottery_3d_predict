

# Prompt: 构建端到端深度学习 3D 彩票预测系统

**角色设定：**
请你扮演一位资深的量化分析师和深度学习工程师，专长于金融时间序列预测。

**任务目标：**
开发一套完整的 Python 框架，用于预测“福彩3D”（3位数，0-9）的开奖结果。系统必须使用现代深度学习架构（LSTM + Attention）来捕捉统计独立事件中的“短期惯性”规律。最终目的是通过严格的“滚动窗口回测（Walk-Forward Validation）”，为**下一期**输出一份可靠的“最佳100注购买方案”。

**背景与约束：**
* **数据结构：** 3D彩票包含百位、十位、个位。
* **预测目标：** 虽然最终购买的是“组选”（不分顺序），但模型训练需要基于位置概率。
* **核心约束：** 模拟真实交易场景，严禁使用“未来函数”（Look-ahead Bias/Data Leakage）。

---

## 技术需求与实施路线图

### 第一阶段：高维特征工程 (Feature Engineering - 核心)
你需要将原始历史数据转化为高维特征矩阵。对于每一个历史时间点 $t$，仅使用 $t-1, t-2...$ 的数据生成以下四类特征：

1.  **基础物理属性 (Basic Physics):**
    * **数值归一化：** $N_1, N_2, N_3$。
    * **和值 (Sum):** $\sum N$ (0-27)。
    * **跨度 (Span):** $\max(N) - \min(N)$。
    * **比例特征：** 奇偶比、大小比、质合比。

2.  **高级形态结构 (Advanced Morphology):**
    * **AC值 (算术复杂性):** 计算三个号码两两差值的去重个数（衡量号码的随机度/离散度）。这是衡量“乱度”的关键指标。
    * **形态编码 (Shape):** 组三（对子）、组六（三不同）、豹子（三同）的 One-hot 编码。
    * **012路 & 和尾：** 号码及和值模3的余数；和值的个位数。

3.  **统计趋势与惯性 (Statistical Trends):**
    * **遗漏值 (Omission):** 0-9 每个数字在百/十/个位当前缺失的期数。
    * **滚动统计：** 过去 5/10/30 期和值的均值、标准差、偏度。
    * **相关系数 (Rolling Correlation):** 计算窗口为30的滚动相关系数，例如 ($N_1$ 与 $N_2$) 的联动性，($N_1$ 与 和值) 的相关性。

4.  **玄学逻辑数字化 (Metaphysical Logic):**
    * **五行生克 (WuXing):** 将数字映射为五行 (0/5土, 1/6水 等)。计算上一期对本期的“生克/转化”关系特征。
    * **公仔换位 (Pattern Shift):** 检测斜连号或位置互换 (如 $N_2(t-1) == N_1(t)$)。
    * **个位振幅 (Unit Points):** $N_3$ 与上期 $N_3$ 的距离。

### 第二阶段：模型架构 (Multi-Task Learning)
使用 `TensorFlow/Keras` 或 `PyTorch` 实现一个混合模型：
* **输入 (Input):** 形状 `(Batch_Size, Time_Steps=30, Feature_Dim)`.
* **骨干网络 (Backbone):** 双向 LSTM (Bi-LSTM, 2层) + Self-Attention 机制（用于捕捉长距离依赖和特定形态）。
* **多头输出 (Multi-Head Outputs):**
    1.  **数字预测头 (Digit Head):** `Dense(10, sigmoid)` - 输出 0-9 每个数字出现的概率 (多标签任务)。
    2.  **形态分类头 (Shape Head):** `Dense(3, softmax)` - 预测 组六 vs 组三 vs 豹子。
    3.  **和值预测头 (Sum Head):** `Dense(28, softmax)` - 预测和值 0-27 的概率分布。
    4.  **AC值预测头 (AC Head):** `Dense(3, softmax)` - 预测下一期 AC值为 1, 2 或 3 的概率。

### 第三阶段：滚动回测与策略执行 (Rolling Backtest & Strategy)
针对最近 50 期数据实现 **Walk-Forward Validation** 循环：
* **循环逻辑：**
    1.  使用历史 $[0, T]$ 进行训练。
    2.  预测第 $T+1$ 期。
    3.  **生成 100 注方案 (核心策略):**
        * **Step A (定胆):** 从 Digit Head 选出概率最高的 5 个“胆码”。
        * **Step B (杀号):** 剔除概率最低的 2 个号码。
        * **Step C (生成):** 生成剩余号码的所有组合。
        * **Step D (过滤 - Filter):** 保留组合，当且仅当：
            * 组合的和值在 Sum Head 预测的前 5 个高概率和值范围内。
            * 组合的 AC值符合 AC Head 的高概率预测 (或通过加权评分筛选)。
        * **Step E (排序):** 根据联合概率 $P(N_1) \times P(N_2) \times P(N_3)$ 降序排列，截取前 100 注。
    4.  **止损风控 (Stop-Loss):** 如果模型的最大置信度 < 阈值 (如 0.6)，返回“空仓/观望”信号，不进行购买。
    5.  **评估:** 对比 $T+1$ 期真实结果，计算盈亏 (P&L)。

### 第四阶段：输出要求
请提供完整的 Python 代码结构，包含以下模块：
1.  `FeatureEngineer` 类：处理上述四类特征（重点实现 **AC值** 和 **滚动相关系数** 的计算逻辑）。
2.  `LotteryModel` 类：定义神经网络架构。
3.  `StrategyEngine` 类：包含过滤逻辑和 100 注生成算法。
4.  `Backtester` 函数：执行滚动训练和验证的主循环。

**注意：** 代码必须模块化，包含详细注释，并预留 CSV 数据加载接口。请确保逻辑严密，特别是策略中的“AC值过滤”和“组选/形态切换”部分。
